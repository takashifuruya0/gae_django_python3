{% extends 'base.html' %}
{% load static %}
{% block title %}Photo{% endblock %}
{% block body %}
<div class="row">

  <div class="col-6">
    <button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
      <i class="fas fa-cloud"></i> Word Cloud
    </button>
  </div>
  <div class="col-6">
    <button class="btn btn-secondary btn-block" type="button" onclick="{location.reload()}">
      <i class="fas fa-random"></i> Re-Sample
    </button>
  </div>
  <div class="col-12">
    <div class="collapse show" id="collapseExample">
      <div class="card">
        <div id="wordcloud"></div>
      </div>
    </div>
  </div>
  <div class="col-12">
    <p id="ajax_response"></p>
  </div>
</div>

<div class="row">
  <div class="col-12">
  {% for l in labels %}
    <h5>
      <span class="badge badge-warning">
        {{l.val}}
        <a href="?">
          <i class="fas fa-times-circle"></i>
        </a>
      </span>
    </h5>
  {% endfor %}
  </div>
</div>
<hr>

<div class="row">
  {% for p in photo %}
  <div class="col-6 col-md-4 col-lg-3">
    <div class="card">
      <img class="card-img-top"
           {% if p.path_resized %}
           src="{%static p.path_resized %}"
           {% else %}
           src="{%static p.path %}"
           {% endif %}
           width="100%"
           title="{{p.datetime|date}}"
           data-toggle="modal" data-target="#{{p.id}}"
      >
    </div>
  </div>
  <hr>
  {% endfor %}

  {% for p in photo %}
  <!-- Modal order-->
  <div class="modal fade" id="{{p.id}}" tabindex="-1" role="dialog" aria-labelledby="order" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">
            {{p.sitename}}
          </h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <img src="{%static p.path_resized %}" width="100%">
          <table class="table">
            <tr>
              <td>
                <h5>
                  Country: <a class="badge bg-warning" href="?country={{p.country}}">{{p.country}}</a>
                </h5>
              </td>
              <td>
                <h5>
                  Prefecture: <a class="badge bg-warning" href="?prefecture={{p.prefecture}}">{{p.prefecture}}</a>
                </h5>
              </td>
            </tr>
            <tr>
              <th>Comment</th>
              <td>{{p.comment}}</td>
            </tr>
          </table>
          <a class="btn btn-info" href="{% url 'ra:photo_edit' id=p.id%}">Edit</a>
        </div>
        <div class="modal-footer">
          <p>{{p.path}} on {{p.datetime|date}}</p>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block script %}
<!-- word cloud -->
<script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
<script src="{% static 'js/d3.layout.cloud.js' %}"></script>
{#<script src="{% static 'js/cloud.js'%}"></script>#}
<script>
var TARGET_ELEMENT_ID = '#wordcloud'; // 描画先
{#d3.json(DATA_FILE_PATH).then(function(data) { // v5#}
if (window.innerWidth > 768) {
  var h = 400;
  var w = 1200;
}else{
  var h = 400;
  var w = 400;
}

function test_h(text){
  window.alert(text);
  draw_wc(data_list);
}

var data_list = [
  {% for td in wordcloud_list %}
  {
    "word": "{{td.word}}",
    "count": {{td.count}},
    "url": "{{td.url}}",
  },
{% endfor %}
]
function draw_wc(data){
  var random = d3.randomIrwinHall(2); // アーウィンホール分布
  var countMax = d3.max(data, function(d){ return d.count} );
  var sizeScale = d3.scaleLinear().domain([0, countMax]).range([10, 100])

  var words = data.map(function(d) {
    return {
    url: d.url,
    text: d.word,
    size: sizeScale(d.count) //頻出カウントを文字サイズに反映
    };
  });
  d3.layout.cloud().size([w, h])
    .words(words)
    .rotate(function() { return (~~(Math.random() * 6) - 3) * 30; })
    .font("Impact")
    .fontSize(function(d) { return d.size; })
    .on("end", draw) //描画関数の読み込み
    .start();

  // wordcloud 描画
  function draw(words) {
    d3.select(TARGET_ELEMENT_ID)
      .append("svg")
        .attr("class", "ui fluid image") // style using semantic ui
        .attr("viewBox", "0 0 " + w + " " + h )  // ViewBox : x, y, width, height
        .attr("width", "100%")    // 表示サイズの設定
        .attr("height", "100%")   // 表示サイズの設定
      .append("g")
        .attr("transform", "translate(" + w / 2 + "," + h / 2 + ")")
      .selectAll("text")
        .data(words)
      .enter().append("text")
        .style("font-size", function(d) { return d.size + "px"; })
        .style("font-family", "Impact")
        .style("fill", function(d, i) { return d3.schemeCategory10[i % 10]; })
        .attr("text-anchor", "middle")
        .attr("transform", function(d) {
          return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
        })
        .text(function(d) { return d.text; })
        .on("click", function (d, i){
          window.location.href = d.url;
          // ajax
          <!--$.ajax({-->
            <!--url: "{% url 'ra:ajax' %}",-->
            <!--method: "GET",-->
            <!--data: "",-->
            <!--timeout: 10000,-->
            <!--dataType: "json",-->
          <!--})-->
          <!--.done(function(data_ajax) {-->
            <!--d3.select(TARGET_ELEMENT_ID).select('svg').remove();-->
            <!--draw_wc(data_ajax);-->
          <!--})-->
        });
  }
}

draw_wc(data_list)
</script>
{% endblock %}